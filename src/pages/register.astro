---
import Layout from '../layouts/Layout.astro';
import { db } from '../lib/db';
import { users } from '../lib/auth/schema';

// Check if registration is allowed (no users exist)
try {
    const [existingUser] = await db.select().from(users);
    if (existingUser) {
        return Astro.redirect("/login");
    }
} catch (error) {
    console.error('Database error:', error);
    return new Response('Database error', { status: 500 });
}
---

<Layout title="Register - DokkuBase">
    <main>
        <h1>Create Admin Account</h1>
        <form id="register-form" class="register-form">
            <div id="error-message" class="error-message" style="display: none; color: red; margin-bottom: 1rem;"></div>
            
            <div class="field">
                <label for="email">Email</label>
                <input type="email" id="email" name="email" required />
            </div>
            
            <div class="field">
                <label for="password">Password</label>
                <input type="password" id="password" name="password" required />
            </div>

            <button type="submit">
                <span class="button-text">Create Account</span>
                <span class="loading-spinner" style="display: none"></span>
            </button>
        </form>
    </main>
</Layout>

<script>
    const form = document.querySelector("#register-form") as HTMLFormElement;
    const button = form.querySelector("button") as HTMLButtonElement;
    const buttonText = button.querySelector(".button-text") as HTMLSpanElement;
    const spinner = button.querySelector(".loading-spinner") as HTMLSpanElement;
    const errorDiv = document.querySelector("#error-message") as HTMLDivElement;

    form.addEventListener("submit", async (e) => {
        e.preventDefault();
        const formData = new FormData(form);
        
        // Clear previous errors
        errorDiv.style.display = "none";
        errorDiv.textContent = "";
        
        // Show loading state
        button.disabled = true;
        buttonText.textContent = "Creating account...";
        spinner.style.display = "inline-block";

        try {
            const res = await fetch("/api/auth/register", {
                method: "POST",
                body: JSON.stringify({
                    email: formData.get("email"),
                    password: formData.get("password")
                }),
                headers: {
                    "Content-Type": "application/json"
                }
            });

            const data = await res.json();

            if (!res.ok) {
                throw new Error(data.error || "Registration failed");
            }
            
            // Redirect to dashboard on success
            window.location.href = "/";
        } catch (err) {
            console.error(err);
            // Show error message
            errorDiv.textContent = err instanceof Error ? err.message : "Registration failed";
            errorDiv.style.display = "block";
        } finally {
            // Reset loading state
            button.disabled = false;
            buttonText.textContent = "Create Account";
            spinner.style.display = "none";
        }
    });
</script>

<style>
    main {
        max-width: 800px;
        margin: 0 auto;
        padding: 2rem;
    }

    .register-form {
        max-width: 400px;
        margin: 2rem auto;
        padding: 2rem;
        border: 1px solid #ddd;
        border-radius: 8px;
    }

    .field {
        margin-bottom: 1rem;
    }

    .field label {
        display: block;
        margin-bottom: 0.5rem;
    }

    .field input {
        width: 100%;
        padding: 0.5rem;
        border: 1px solid #ddd;
        border-radius: 4px;
    }

    button {
        width: 100%;
        padding: 0.75rem;
        background: #000;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
    }

    button:hover {
        opacity: 0.9;
    }
</style>